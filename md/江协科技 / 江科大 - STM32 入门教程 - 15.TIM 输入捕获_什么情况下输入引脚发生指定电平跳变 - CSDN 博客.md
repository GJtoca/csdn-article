> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [blog.csdn.net](https://blog.csdn.net/m0_61712829/article/details/133319855?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22133319855%22%2C%22source%22%3A%22m0_61712829%22%7D)

**目录**

[一、输入捕获](#%E4%B8%80%E3%80%81%E8%BE%93%E5%85%A5%E6%8D%95%E8%8E%B7)

[1.1 输入捕获简介](#1.1%20%E8%BE%93%E5%85%A5%E6%8D%95%E8%8E%B7%E7%AE%80%E4%BB%8B)

[1.2 输入捕获的各部分电路](#t0)

[​编辑](#t1) 

[1.3 输入捕获的主模式、从模式、触发源选择（简称：主从触发模式）](#t2)

[​编辑​编辑](#t3)

[​编辑 1.4 输入捕获和 PWMI 基本结构](#t4)

[二、频率的测量方法](#t5)

[2.1 测频法](#t6)

[2.2 测周法](#t7)

[2.3 测频法和测周法的误差分析](#t8)

[2.4 用 STM32 来实现测频法和测周法](#t9)

[三、手册](#t10)

[0. 江协科技 / 江科大 - STM32 入门教程 - 各章节详细笔记 - 查阅传送门 - STM32 标准库开发_stm32 江协大 csdn-CSDN 博客文章浏览阅读 3.4k 次，点赞 47 次，收藏 143 次。江协科技 / 江科大 - STM32 标准库开发 - 各章节详细笔记 - 传送门至各个章节笔记。基本上课程讲的每句都详细记录，方便回顾。_stm32 江协大 csdn![](https://i-blog.csdnimg.cn/blog_migrate/be19846480ab44ce477585fc567aeaa0.png)https://blog.csdn.net/m0_61712829/article/details/132434192?spm=1001.2014.3001.5501](https://blog.csdn.net/m0_61712829/article/details/132434192?spm=1001.2014.3001.5501 "0. 江协科技/江科大-STM32入门教程-各章节详细笔记-查阅传送门-STM32标准库开发_stm32江协大 csdn-CSDN博客")

### 一、输入捕获  
1.1 输入捕获简介

  
  输入捕获，即 Input Capture，英文缩写为 IC。输入捕获模式下，当通道输入引脚出现指定电平跳变瞬间（可以定义为上升沿、下降沿），当前 CNT 的值将被锁存到 CCR 中（检测电平跳变，然后执行动作（作用和外部中断差不多，只不过外部中断执行的动作是向 CPU 申请中断，输入捕获执行的是控制后续电路）），可用于测量 PWM 波形的频率、占空比、脉冲间隔、电平持续时间等参数。在这里，脉冲间隔和频率差不多、电平持续时间和占空比也是互相对应的关系。

       每个高级定时器和通用定时器都拥有 4 各输入捕获通道，且二者没有区别。基本定时器没有输入捕获的功能。  
  输入捕获模块可以配置为 PWMI（PWM 输入）模式和主从触发模式。PWMI 模式是 PWM 的输入模式，专门用来同时测量 PWM 波形的频率和占空比的。主从触发模式可以实现对频率或占空比的硬件的全自动测量。把这两个功能结合起来，测量频率和占空比就是硬件全自动执行，软件不需进行任何干预，也不需进中断，需要测量的时候，直接读取 CCR 寄存器就行了，使用非常方便且极大地减轻了软件的压力。

        如下图，左边为输入捕获电路，4 个输入捕获和输出比较通道，共用 4 个 CCR 寄存器，另外它们的 CH1 到 4 的 4 个通道引脚也是共用的，所以对于同一个定时器，输入捕获和输出比较只能使用其中一个，不能同时使用。

> 输入捕获对比输出比较：
> 
> *   输出比较，引脚是输出端口，根据 CNT 和 CCR 的大小关系来执行输出动作
> *   输入捕获，引脚是输入端口，接收到输入信号执行 CNT 锁存到 CCR 的动作

#### 1.2 输入捕获的各部分电路

        从左向右依次进行电路分析：

#### ![](https://i-blog.csdnimg.cn/blog_migrate/4b152c655002d5380d9785af0356c48c.png)       

*   最左边是四个通道的引脚，参考引脚定义表，就指导引脚是复用在哪个位置

![](https://i-blog.csdnimg.cn/blog_migrate/35a7524d4843b18f819f3d61d324488d.png)

*   然后引脚进来，有一个三输入的异或门，这个异或门的输入接在了通道 1、2、3 端口，异或门的执行逻辑是，当三个引脚的任何一个有电平翻转时，输出引脚就产生一次电平翻转，3 个引脚电平都相同为 0，3 个引脚中有高有低为 1。

![](https://i-blog.csdnimg.cn/blog_migrate/21e6bd31ef7ca438b3fca207b42450b2.png)

*   然后输出通过数据选择器，到达输入捕获通道 1，数据选择器如果选择上面一个，那输入捕获通道 1 的输入就是三个引脚的异或值；若选择下面一个，异或门就没有用。设计异或门，其实还是为了三相无刷电机服务的，无刷电机有三个霍尔传感器检测转子的位置，可以根据转子的位置来进行换相。
    

![](https://i-blog.csdnimg.cn/blog_migrate/dbd74a4aa81946219d05f625e59b7211.png)

*   输入信号来到了输入滤波器和边沿检测器（极性选择）。输入滤波器可以对信号进行滤波，避免一些高频的毛刺信号误触发；边沿检测器就是和外部中断一样，可以选择高电平触发或者低电平触发，当出现指定的电平时，边沿检测电路就会触发后续电路执行动作。设计了两套滤波和边沿检测电路，第一套电路经过滤波和极性选择得到 TI1FP1，输入给通道 1 的后续电路。第二套电路，经过另一个滤波和极性选择，得到 TI1FP2，输入给通道 2 的后续电路，同理，下面 TI2 信号进来，也经过两套滤波和极性选择得到 TI2FP1 输入通道 1 和 TI2FP2 输入通道 2。可以进行交叉连接，例如 CH1 引脚输入给通道 2，CH2 引脚输入给通道 1，进行交叉连接的目的是两个：1. 一个通道灵活切换两个引脚，可以灵活切换后续捕获电路的输入，2. 两个通道同时捕获一个引脚，可以把一个引脚的输入，同时映射到两个捕获单元，这也是 PWMI 模式的经典结构，实现两个通道（IC）对一个引脚（CH）进行捕获，就可以同时测量频率和占空比。可以选择各自独立连接，也可以选择进行交叉连接。另外还有一个 TRC 信号，也可选择作为捕获部分的输入，TRC 信号来源于最上面，设计也是为了无刷电机的驱动。

![](https://i-blog.csdnimg.cn/blog_migrate/364f02dff444ff8d9c14e7a4823da362.png)

*   然后来到了预分频器。每个通道各有一个预分频器，可以选择对前面的信号进行分频，分频之后的触发信号，就可以触发电路进行工作了，每来一个触发信号，CNT 的值就会向 CCR 转运一次，转运的同时会发生一个捕获事件，这个事件会在状态寄存器置标志位，同时也可以产生中断，如果需要在捕获的瞬间，处理一些事情的话，就可以开启这个捕获中断，比如可以配置上升沿触发捕获，每来一个上升沿，CNT 转运到 CCR 一次，又因为 CNT 计数器是由内部的标准时钟驱动的，所以 CNT 的数值可以用来记录两个上升沿之间的时间间隔（周期）再取倒数就是测周法测量的频率了，在一次捕获后将 CNT 清零（可以用主从触发模式来自动完成 CNT 清零）

![](https://i-blog.csdnimg.cn/blog_migrate/388c51a129252c70d122744eddbac6d0.png)

  
  输入捕获通道 1 的详细框图如下所示：（如下是上面框图的一个细化结构，基本功能都是一样的）

![](https://i-blog.csdnimg.cn/blog_migrate/52eee81a40d2c25b2bc9d1110590d7b5.png)

         如上图，电路细节内容如下：

*   引脚进来，先经过一个滤波器，滤波器的输入是 TI1 就是 CH1 的引脚，输出的 TI1F 就是滤波后的信号
    
*   FDTS 是滤波器的采样时钟来源
    
*   CCMR1 寄存器里的 ICF 位可以控制滤波器的参数
    
*   滤波器的工作原理就是：以采样频率对输入信号进行采样，当连续 N 个值都为高电平，输出才为高电平，当连续 N 个值都为低电平，输出才为低电平，如果信号出现高频抖动，导致连续采样 N 个值不全都一样，那输出就不会变化，这样就可以达到滤波的效果。采样频率越低，采样个数 N 越大，滤波效果就越好。在实际应用中，如果波形噪声比较大，就可以把 IC1F 位参数设置大一点来过滤噪声。
    
*   滤波之后的信号通过边沿检测器。捕获上升沿或者下降沿
    
*   CCER 寄存器里的 CC1P 位可以进行极性选择
    
*   最终得到 TI1FP1 触发信号
    
*   通过数据选择器，进入通道 1 后续的捕获电路。
    

![](https://i-blog.csdnimg.cn/blog_migrate/0a50a4da1577abdbda02be9a66b5ca58.png)

*   当然还有一套一样的电路得到 TI1FP2 触发信号，连通到通道 2 的后续电路，上图并没有画出来，同样，通道 2 有 TI2FP1 连通到通道 1 的后续，通道 2 也有 TI2FP2 连通到通道 2 的后续，总共有四种连接方式，然后经过数据选择器，进入后续捕获部分电路
*   CCMR 寄存器的 CC1S 位可以对数据选择器进行选择
*   之后，CCMR 寄存器的 ICPS 位可以配置分频器，可以选择不分频、2 分频、4 分频、8 分频
*   CCMR 寄存器的 CC1E 位，控制输出使能或失能。如果使能了输出，输入端产生指定边沿信号，经过层层电路，就可以最后将 CNT 的值转运到 CCR 里来，每捕获一次 CNT 的值，都要把 CNT 清 0 一下，以便于下一次的捕获，从模式控制器就可以在捕获之后自动完成 CNT 的清零工作
*   TI1FP1 信号和 TI1F_ED 边沿信号，都可以通向从模式控制器，比如 TI1FP1 信号的上升沿触发捕获，还可以同时触发从模式，这个从模式里就有电路，可以自动完成 CNT 的清零。从模式就是完成自动化操作的利器

![](https://i-blog.csdnimg.cn/blog_migrate/faefcb11d19d943c9728f8ee75c656e1.png)

####   
1.3 输入捕获的主模式、从模式、触发源选择（简称：主从触发模式）

![](https://i-blog.csdnimg.cn/blog_migrate/efdb8eda1677e0f3b82d5cbfc1aa66ce.png)

  CCR 对 CNT 进行捕获之后，需要对 CNT 进行一次清 0 操作，这样每次捕获得到的值才是测周法，两个上升沿（下降沿）之间的时间间隔。这个清 0 操作，就需要用到主从触发模式来自动完成。由输入捕获通道 1 的详细框图可得：经过滤波和极性选择的 TI1FP1 信号和经过滤波的边沿信号 TI1F_ED 都可以通向从模式控制器，之后便可以通过硬件电路自动完成 CNT 的清 0 操作。  
  主从触发模式，即主模式、从模式和触发源选择三个功能的简称。主模式可以将定时器内部的信号映射到 TRGO 引脚，用于触发其他外设的操作；从模式可以接收其他外设或自身外设的一些信号，用于触发自己的一些操作（定时器的运行）；触发源选择，即选择从模式的触发信号源功能，也可以认为它是从模式的一部分。  
  在从模式下，可以通过触发源选择功能选择一个信号产生 TRGI 信号，之后去触发从模式，从模式可以在上面列表中选择一项操作来自动执行。关于主从模式的详细说明可以参见手册：

#### ![](https://i-blog.csdnimg.cn/blog_migrate/1cee83cfe5d7ecc95607d8e1cab1bc78.png)![](https://i-blog.csdnimg.cn/blog_migrate/4b0c481f78b80af1262dfc4d6bc15248.png)

#### ![](https://i-blog.csdnimg.cn/blog_migrate/adb265eb30187cf787a9fdf1d054139e.png)  
1.4 输入捕获和 PWMI 基本结构

1.4.1 输入捕获基本结构  

        下图是输出捕获模式测频率的基本结构图。

![](https://i-blog.csdnimg.cn/blog_migrate/21a39c3329530545d06acc239ef2ec53.png)  
  上图清晰地展示了输入捕获模式测量频率的过程，同时也是编程的逻辑基础。在这里我们只使用了一个通道，所以它只能测量频率。  
  首先，配置时基单元，启动寄存器，则 CNT 就会在预分频之后的时钟驱动下不断自增。测周法用 CNT 来计数，间接实现计时的功能。经过预分频后的时钟频率，就是测周法的标准频率 fc。之后，GPIO 输入一个待测的方波信号，经过经过滤波器和边沿检测选择 TI1FP1 为上升沿触发，之后数据选择器选择直连通道，分频器选择不分频。当 TI1FP1 出现上升沿之后，CNT 的值就会被 CCR1 转运捕获；同时触发源选择模块选择 TI1FP1 为触发信号，从模式选择复位操作，触发 CNT 清零（先后顺序是：先转运 CNT 的值到 CCR，再触发从模式给 CNT 清零。或者是非阻塞的同时转移：CNT 的值转移到 CCR，同时 0 转移到 CNT 里面去，总之是先捕获，再清零）。当电路不断工作时，CCR1 中的值始终是最新一个周期的计数值，即测周法的计次数 N。所以，当我们想读取信号的频率时，只需要读取 CCR1 得到 N，再计算 fc/N 就得到频率了。当不需要读取时，整个电路全自动的测量，不需要占用任何软件资源。

>   这里需要注意以下两点：
> 
> *   CNT 的计数值是有上限的。由于 ARR 最大为 65535，故 CNT 最大也只能计 65535 个数。如果信号频率太低，CNT 的计数值可能会溢出。
> *   从模式的触发源选择中有 TI1FP1 和 TI2FP2，但是没有 TI3 和 TI4 的信号。所以如果要使用从模式自动清零 CNT，就必须使用通道 1 或通道 2 作为输入。对于通道 3 和通道 4，就只能开启捕获中断，在中断中手动清 0 了（程序会处于频繁中断的状态，比较占用软件资源）。

1.4.2 PWMI 基本结构

![](https://i-blog.csdnimg.cn/blog_migrate/59cfa7f390cabe8cc4e7f4fe14ae5285.png)

        PWMI 模式使用两个通道同时捕获一个引脚，可以同时测量周期和占空比，相比前面输入捕获，下面多了一个 TI1FP2 的通道。

        首先 TI1FP1 配置上升沿触发，触发捕获和清零 CNT，正常的捕获周期，再来一个 TI1FP2，配置为下降沿触发，通过交叉通道去触发通道 2 的捕获单元（最开始上升沿 CCR1 捕获同时清零 CNT，之后 CNT 一直加，然后在下降沿时刻触发 CCR2 捕获，这时 CCR2 的值就是 CNT 从上升沿到下降沿的计数值也就是高电平期间的计数值，CCR2 捕获并不触发 CNT 清零，所以 CNT 继续加，直到下一次上升沿，CCR1 捕获周期并 CNT 清零，这样执行之后 CCR1 就是一整个周期的计数值，CCR2 就是高电平期间的计数值，用 CCR2/CCR1 就是占空比，以上就是 PWMI 模式使用两个通道来捕获频率和占空比的思路。另外也可以两个通道同时捕获第一个引脚的输入）

### 二、频率的测量方法

![](https://i-blog.csdnimg.cn/blog_migrate/9e926e74c08a03b9411ccf1b796ece2b.png)

  如上图是频率逐渐降低的方波波形，越往左频率越高，越往右频率越低，这里信号都是只有高低电平的数字信号，对于 STM32 测频率而言，它也是只能测量数字信号的。如果需要测量一个正弦波则需要搭建一个信号预处理电路，最简单的就是用运放搭建一个比较器，把正弦波转换为数字信号再输入给 STM32 就行了；如果你测量的信号电压非常高，那还要考虑隔离的问题，比如使用隔离放大器、电压互感器等元件，隔离高压端和低压端，保证电路的安全。总之，经过处理最终输入给 STM32 的信号是如上图的高低电平信号，高电平 3.3v，低电平 0v。

        为了测量频率，有两种方法可以选择：测频法、测周法

        测频法：定时器中断，并记录捕获次数；测周法：捕获中断，并记录定时器次数。

#### 2.1 测频法

  
  测频法的测试方法（直接按频率定义来进行测量的方法）是：在闸门时间 T 内，对上升沿（也可以是下降沿）计次，得到 N，则待测信号频率𝑓𝑥 为：                                 

                                                                𝑓𝑥 = 𝑁 / 𝑇

![](https://i-blog.csdnimg.cn/blog_migrate/5d0b95ece141e88b1b7fc3dca89176c7.png)

  例如，可以定义闸门时间闸门时间 T=1s （砸门时间不是必须为 1s），则在一秒中得到的上升沿的个数（每来一个上升沿就是完整的一个周期的信号个数）就是频率

> 频率的定义就是，1s 内出现了多少个重复的周期，那频率就是多少 Hz

#### 2.2 测周法

  
  测周法的测试方法是：两个上升沿内，以标准频率 fc 计次，fc=72M/（psc+1），得到 N(就是读取 CCR 的值），则测量频率𝑓𝑥为：  
                                                        𝑓𝑥 = 𝑓𝑐 / 𝑁 

![](https://i-blog.csdnimg.cn/blog_migrate/1dc6e53344f4ec0118aacbd670a06302.png)

  测周法的基本思想是：周期的倒数就是频率。如果我们能用定时器测量出一个周期的时间（相邻上升沿或相邻下降沿的间隔时间）取倒数即得到测量频率。

        捕获信号的两个上升沿，然后测量一下两个上升沿之间持续的时间，但是实际上，并没有一个精度无穷大的秒表来测量时间，测量时间的方法，实际上也是定时器计次，我们使用一个已知的标准频率 fc 的计次时钟来驱动计数器，从一个上升沿开始计数器从 0 开始一直计到下一个上升沿停止，计一个数的时间是 1/fc，计 N 个数时间就是 N/fc 也就是周期，再取倒数就得到了频率 fx

       输入捕获模块采用测周法进行测量。

#### 2.3 测频法和测周法的误差分析

  
  测频法适用于测量高频信号，测周法适用于测量低频信号。

        根据上图可以清晰地看出，测频法在闸门时间内，最好要多出现一些上升沿，计次数量多一些有助于减小误差，测频法要求信号频率要稍微高一些，测频法的测量结果更新慢一些，测量结果是一段时间的平均值，值比较平滑，数值相对稳定；对于测周法，就要求信号频率低一些，低频信号，周期比较长，计次就会比较多，有助于减小误差，测周法的测量结果更新的快，只测量一个周期，就能出一次结果，数据跳变也非常快，所以出结果的速度取决于待测信号的频率，一般而言，待测信号都是几百 hz 几千 hz，所以一般情况下，测周法结果更新更快，但是由于它只测量一个周期，所以结果值会受噪声的影响，波动比较大，这就是这两种方法的基本特征对比。

        测频法计次和测周法计次，这个计次数量 N 尽量要大一些，N 越大，相对误差越小，因为在这些方法中，计次可能存在正负 1 误差，要想减小正负 1 误差，就尽量多记一些数，当计次 N 比较大时，正负 1 对 N 的影响就会很小  
  由于测量原理的差异，一般而言，测频法的结果更新频率会比较慢，但是数值较为稳定；测周法的结果更新频率较快，数据跳变也比较灵敏。从原理上看，测频法自带一个均值滤波的功能，如果在闸门时间 T 内被测频率有变化，测频法得到的实际是这一段闸门时间内的平均频率；而测周法只测量一个周期，故其结果会受噪声的影响，波动会比较大。所以，对于测频法和测周法的一个共同点是：N 越大，误差就越小。在两种方法中，计次都可能会产生正负 1 误差。在测频法的一个闸门时间内，并不是每一个被测信号的周期都是完整的；测周法的标准计数信号的信号也不一定是被测信号的整数倍，所以它也不一定是每一个都完整的。对于上述的两种情况，都会出现多计一个数或者少计一个数的情况，所以会产生正负 1 误差。  
  如何在不同情况下正确选择测频法和测周法呢？所以多高算高频，多低算低频，我们有以下一个参数来考量：中界频率，测频法和测周法误差相等的频率点。由于两种方法的误差都与 N 的正负 1 误差有关，所以当两种方法计次的 N 相同时，两种方法的误差也就相同。消去两种方法公式中的 N，将测频法和测周法的 N 提出来，令两个方法 N 相等，将 fx 解出来，可得：

![](https://i-blog.csdnimg.cn/blog_migrate/dc2de7ee4350c10fd5f19fcfad87a7c7.png)

式中，T 是测频法的闸门时间，f c 是测频法的标准频率。

        当待测信号频率小于中界频率时，测周法误差更小，选择测周法更合适；当待测信号频率大于中界频率时，测频法误差更小，选择测频法更合适。

#### 2.4 用 STM32 来实现测频法和测周法

       测频法，之前学过的外设可以实现，对射式红外传感器计次、定时器外部时钟，这些代码稍加改进就是测频法，比如 对射式红外传感器计次，每来一个上升沿计次 + 1，再用一个定时器，定一个 1s 的定时中断，在中断里，每隔 1s 取一下计次值，同时清 0，为下一次做准备，这样每次读取的计次值就直接是频率；对应定时器外部时钟的代码，也是如此，每隔 1s 取一下计次，就能实现测频法测量频率的功能了。

        本节输入捕获测频率，使用的方法是测周法。就是测量两个上升沿之间的时间，来进行频率测量。

### 三、手册

        手册本节相应的内容，描述是寄存器的方式，结合上面笔记内容进行进一步理解

> *   手册中，  脉冲宽度测量就是占空比，  周期测量就是频率
> *   主要理解，从模式配合输入捕获完成硬件自动化

![](https://i-blog.csdnimg.cn/blog_migrate/c09aff5015230af55acf88cbd5904506.png)![](https://i-blog.csdnimg.cn/blog_migrate/9b3c379941721bf478df15f5765947f1.png)![](https://i-blog.csdnimg.cn/blog_migrate/b2b32bdaa8ff3a552010feec18a8e6e5.png)