> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [blog.csdn.net](https://blog.csdn.net/m0_61712829/article/details/132814572?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22132814572%22%2C%22source%22%3A%22m0_61712829%22%7D)

**目录**

[输出比较功能简介](#)

[PWM 简介](#t0)

[输出比较通道（通用定时器）](#t1)

[输出模式控制器的执行逻辑（工作流程）](#t2)

[输出 PWM 波形及参数计算](#t3)

[输出比较通道（高级定时器）](#t4)

[舵机和直流电机](#t5)

 [舵机](#t6)

 [直流电机及驱动](#t7)

[参考手册](#t8)

[0. 江协科技 / 江科大 - STM32 入门教程 - 各章节详细笔记 - 查阅传送门 - STM32 标准库开发_stm32 江协大 csdn-CSDN 博客文章浏览阅读 3.4k 次，点赞 47 次，收藏 143 次。江协科技 / 江科大 - STM32 标准库开发 - 各章节详细笔记 - 传送门至各个章节笔记。基本上课程讲的每句都详细记录，方便回顾。_stm32 江协大 csdn![](https://g.csdnimg.cn/static/logo/favicon32.ico)https://blog.csdn.net/m0_61712829/article/details/132434192?spm=1001.2014.3001.5501](https://blog.csdn.net/m0_61712829/article/details/132434192?spm=1001.2014.3001.5501 "0. 江协科技/江科大-STM32入门教程-各章节详细笔记-查阅传送门-STM32标准库开发_stm32江协大 csdn-CSDN博客")

### 输出比较功能简介

*** 输出比较概述**  
  输出比较，英文全称 Output Compare，简称 OC。它最主要的功能是 可以通过比较计数器 CNT 和捕获 / 比较寄存器（Capture/Compare Register）CCR 值的关系，来输出电平进行置 1、置 0 的翻转操作，用于输出一定频率和占空比的 PWM 波形。  
  每个高级定时器和通用定时器都拥有 4 个输出比较的通道，可以同时输出 4 路 [PWM 波](https://so.csdn.net/so/search?q=PWM%E6%B3%A2&spm=1001.2101.3001.7020)形，且高级定时器的前 3 个通道额外拥有死区生成电路和互补输出的功能（用于驱动三相无刷电机）。4 个输出比较通道都有独立的 CCR 寄存器，但是它们共用同一个 CNT 计数器。

![](https://i-blog.csdnimg.cn/blog_migrate/22599d8f097156ecb073fec3302ec6c6.png)

### PWM 简介

*** PWM 概述**

 PWM（Pulse Width Modulation），即脉冲宽度调制，PWM 波形是一个数字输出信号，是由高低电平组成的，是一种对模拟电平信号进行数字编码的方法。在具有惯性的系统中，可以通过对一系列脉冲的宽度进行调制，来等效地获得所需要的模拟参量，常应用于电机控速等领域。也就是说，使用 PWM 波形，是用来等效地实现一个模拟信号的输出。（例如，led 呼吸灯，电机调速，如下解释）

        以 LED 为例：GPIO 的输出信号只能是数字信号，如果想通过数字信号输出模拟量，可以通过以下的方法实现：让 LED 不断点亮、熄灭、点亮、熄灭，当点亮、熄灭的频率足够大时，由于 LED 的余晖和人眼的视觉暂留效应，LED 就会呈现出一个中等亮度。当调控点亮和熄灭的时间比例时就能让 LED 呈现出不同的亮度级别。  
  对于电机调速也类似：在高频率下不断让电机交替通断，由于电机断电后不会立刻停止，而是由于惯性转动后停下，电机的速度就能维持在一个中等速度。  
  PWM 的秘诀是：天下武功，唯快不破！ 需要注意的是：只有在具有惯性的系统中，才能用 PWM 对模拟信号进行编码。

        从下图可以看出，高低电平跳变的数字信号可以被等效地表示为中间虚线所表示的模拟量。当上面电平时间长一点，下面电平短一点的时候，等效地模拟量就偏向于上面；当下面电平时间长一点，上面电平时间短一点的时候，等效地模拟量就偏向于下面。也就是说，占空比越大，等效的模拟量就越趋近于数字量的高电平；占空比越小，等效的模拟量就越趋近于数字量的低电平，且这个等效关系一般而言是线性一一对应的。

![](https://i-blog.csdnimg.cn/blog_migrate/1942683ba141dc8cf5f25d619ab12748.png)

         使用 PWM 波形，就可以在数字系统等效输出模拟量，就能实现 LED 控制亮度、电机控速等功能了。

*** PWM 参数**

 首先，明白 Ts 就是下图这里，Ts 代表一个高低电平变换周期的时间

![](https://i-blog.csdnimg.cn/blog_migrate/6d4d639d4fe118dbd60d51400d11e24e.png)

        在使用 PWM 对模拟量进行编码时，以下三个参数尤其重要：

        频率 ：f = 1 / Ts（周期的倒数就是频率）；变换越快 = 频率越大（PWM 的频率越快，它等效模拟的信号就越平稳，不过同时性能开销就越大；一般来说 PWM 的频率在几 kHz 到几十 kHz 之间。）

        占空比：q=Ton/Ts( Ton 是高电平的时间，Ts 是一个周期的时间。q 就是高电平时间相对于整个周期时间的比例）；占空比决定了 PWM 等效出的模拟电压的大小。一般用百分比表示。

        分辨率：占空比的变化步距；分辨率就是占空比变化的精细程度。即，占空比最小能以百分之多少的精度变化，它的值可以是 1%、0.1%。分辨率的大小要看实际项目的需求定。如果既要高频率，又要高分辨率，就需要硬件电路要有足够的性能。要求不高的情况下，1% 的分辨率就足够使用了。

### 输出比较通道（通用定时器）

  
  通用定时器的输出比较部分电路如下图所示：

![](https://i-blog.csdnimg.cn/blog_migrate/5c0fe05f8452a6ad801f8b80216ad532.png)

        上图对应的是通用定时器电路里的下图红框部分电路，左边是 CNT 和 CCR 比较的结果，右边是输出比较电路，最后通过 TIM_CH1 输出到 GPIO 引脚上，然后下面还有三个同样的单元，分别输出到 CH2、CH3、CH4。

![](https://i-blog.csdnimg.cn/blog_migrate/86889c761ed963eaf204833268e7c049.png)

  如上图 125 所示，图的左边是 CNT 计数器和 CCR1 第一路的捕获 / 比较寄存器，它俩进行比较，当 CNT = CCR1 或者 CNT > CCR1 时，输出模式控制器就会收到一个信号，输出模式控制器就会改变它输出的 OC1REF 的高低电平。REF 是 Reference 的缩写，意为参考信号。上面有个 ETRF 输入（是定时器的一个小功能，一般不用，不需要了解）  
  接下来 OC1REF 信号兵分两路：一路以将 REF 信号映射到主模式控制器的 TRGO 上，去触发其他外设的功能；不过 REF 的主要去向还是下面这一路，通往一个极性选择电路，通过控制 TIMx_CCER 寄存器的值（0 或 1），可以选择是否将 REF 信号翻转（写 0 信号就会往上走，就是信号电平不翻转，进来哈样出去还是哈样；写 1 信号就会往下走，就是信号通过一个非门取反，输出的信号就是输入信号高低电平反转的信号，这就是极性选择，就是选择是不是要把高低电平反转一下），之后通往输出使能电路，可以控制是否输出，最后通往 OC1 引脚，即 TIMx_CH1 通道的引脚（在引脚定义表中即可找到具体的 GPIO 口）。

补充：

![](https://i-blog.csdnimg.cn/blog_migrate/d325256c34568c93588da0721a8e4538.png)极性选择电路

![](https://i-blog.csdnimg.cn/blog_migrate/1033e949925a891df926f991037fb613.png)非门取反

### 输出模式控制器的执行逻辑（工作流程）

![](https://i-blog.csdnimg.cn/blog_migrate/2376c5a1c40ad6bbf493183ca17f7ecf.png)

        什么时候给 REF 高电平，什么时候给 REF 低电平？  
  输出比较拥有 8 种工作模式 ，其对应了输出模式控制器种的执行逻辑，这个模式控制器的输入是 CNT 和 CCR 的大小关系，输出是 REF 的高低电平，里面可以选择 8 种模式来更灵活地控制 REF 输出，8 种输出模式可以通过 TIM_CCMR1k 寄存器进行配置，需要哪个模式就可以选哪个模式。输出模式控制器的执行逻辑如下表所示：

![](https://i-blog.csdnimg.cn/blog_migrate/64a5b0a89cf484c9312fc1cada6dee1b.png)

*        冻结：CNT = CCR 时维持原状态，实际上此时 REF 与 CNT 和 CCR 都无关，即 CNT 和 CCR 无效，REF 保持为上一个状态。在输出 PWM 波形时，如果要暂停波形输出，且对暂停时的高低电平没有要求，就可以设置为这个模式。
*       匹配时置无效 / 有效电平：CNT = CCR 时 REF 置无效 / 有效电平。这两个模式不适合输出连续变化的波形。如果想定时输出一个 “一次性” 的信号，则可以考虑这两个模式。有效电平和无效电平是高级定时器中的表述，与关断、刹车等功能配合表述的，这里表述的比较严谨。在这里为了理解方便，可以直接认为有效电平就是高电平，无效电平就是低电平。
*       匹配时电平翻转：CNT = CCR 时 REF 电平翻转。这个模式可以方便地输出一个频率可调，占空比稳定为 50% 的 PWM 波形。比如：你设置 CCR 为 0，那 CNT 每次更新清 0 时，就会产生一次 CNT=CCR 的事件，这就会导致输出电平翻转一次，每更新两次，输出为一个周期并且高电平和低电平的时间是始终相等的，也就是占空比始终为 50%，当你改变定时器更新频率时，输出波形的频率也会随之改变。改变计数器的更新频率时，输出波形的频率 = 更新频率 / 2（因为更新两次输出才为一个周期，这就是匹配时电平翻转的用途）
*      强制为无效 / 有效电平：与冻结模式类似。如果想暂停波形输出，并且在暂停期间保持低电平或者高电平，可以考虑这两个模式。
*      PWM 模式 1/2：可以用于输出频率和占空比都可调的 PWM 波形。是我们主要使用的模式。一般我们都只使用 PWM 模式 1 向上计数。向上 / 向下计数之间也只有大小关系、极性不用，基本思想都是一样的。PWM 模式 1/2 的向上计数区别就是输出的高低电平反过来了， PWM 模式 2 就是 PWM 模式 1 取反得到的。改变 PWM 模式 1/2，只是改变了 REF 电平的极性而已。（REF 输出之后还有一个极性的配置（极性选择电路），所以使用 PWM 模式 1 的正极性和 PWM 模式 2 的反极性最终的输出是一样的，输出模式中可以设置极性，最终输出前也可以设置极性）

### 输出 PWM 波形及参数计算

  
  以 PWM 模式 1、向上计数模式为例，PWM 波形产生原理（输出 PWM 的基本结构）如下图所示：

![](https://i-blog.csdnimg.cn/blog_migrate/a0a64607f5402e062cc57499d4c4d7d0.png)

  在上图中，首先左上角是时间单元和运行控制部分，再左边是时钟源选择（省略上一小节内容），在这里我们不需要使用更新事件的中断申请（输出 PWM 暂时还不需要中断）这就是时基单元的部分。配置好了时基单元，这里的 CNT 就可以开始不断地自增运行了。然后，下面粉红区域就是输出比较单元了，总共有四路，输出比较单元的最开始是 CCR 捕获 / 比较寄存器，CCR 是我们自己设定的，CNT 不断自增运行，同时它俩还在不断进行比较；CCR 捕获 / 比较寄存器后面是输出模式控制器，在这里以 PWM 模式 1 为例，是 PWM 模式 1 的执行逻辑，那它是怎么输出 PWM 波形的，解释如下，右上角图中，蓝色线是 CNT 的值，黄色线是 ARR 的值，蓝色线从 0 开始自增，一直增到 ARR 也就是 99，之后清 0 继续自增，在这个过程中红色线是 CCR，比如设置 CCR 为 30，执行输出模式控制器里的逻辑，下面的绿色线就是输出，可以看到 CNT<CCR 时置高电平，之后 CNT>=CCR 就变为低电平，当 CNT 溢出清 0 后，CNT 又小于 CCR 所以置高电平... 这样一直持续下去，REF 的电平就会不断变化，并且它的占空比是受 CCR 的值的调控的，如果 CCR 的值设置的高一些，输出的占空比就会变大，CCR 设置的低一点，输出的占空比就会变小，以上就是 PWM 的工作流程。（这里 REF 就是一个频率可调，占空比也可调的 PWM 波形），最终再经过极性选择，输出使能，最终通向 GPIO 口，这样就能完成 PWM 波形的输出了。需要注意的是： 设置的 CCR 值越接近 ARR，输出的 PWM 波形的占空比就越大。

> ![](https://i-blog.csdnimg.cn/blog_migrate/4d841a60e7e399200464e100b601eb2d.png)
> 
>         PWM 的一个周期如上图中的下面绿色区段的红线区间，可以看出它始终对应着计数器的一个溢出更新周期，所以 PWM 的频率就等于计数器的更新频率
> 
>         当 CNT = CCR 时电路已经置为低电平，故 REF 为高电平的时间为 CNT 从 0 变到 29（30 个数）的时间。
> 
>         CCR 的值应设置在 0 到 ARR+1 的范围里，CCR=ARR+1 时占空比是 100%，ARR 越大，CCR 的范围就越大，对应的分辨率就越大
> 
> 参数计算公式如下所示：
> 
> *   PWM 频率：即计数器的更新频率 Freq = CK_PSC / (PSC + 1) / (ARR + 1)
> *   PWM 占空比：Duty = CCR / (ARR + 1)
> *   PWM 分辨率：即占空比变化的步距 Reso = 1 / (ARR + 1)，以上定义的分辨率是占空比最小的变化步距。ARR 越大，CCR 的变化范围就越大，分辨率就越高。（占空比变化的越细腻越好）

### 输出比较通道（高级定时器）

        这个电路仅作了解即可，不需掌握。

### ![](https://i-blog.csdnimg.cn/blog_migrate/ea60cfb0da5ad0aca7237a8650a71874.png)

### 舵机和直流电机

####   
 舵机

![](https://i-blog.csdnimg.cn/blog_migrate/61e874d980f3282a47a8be8250101b3a.png)![](https://i-blog.csdnimg.cn/blog_migrate/0543a58f0f5543a9920ee93525fef499.png)

        舵机是小型直流伺服电机的一种，是一种根据输入 PWM 信号占空比来控制舵机输出轴的角度的装置。它有三根输入线，其中两根是电源线，一根是 PWM 信号输入线。白色输出轴会固定在一个指定的角度不动，固定的位置是由信号线的 PWM 信号来决定的，这就是舵机的工作方式。

        上边右图中可以看出，舵机其实并不是一种单独的电机，可以发现它是由一个直流电机、一个减速齿轮组、一个电位器（电压编码器）和一个控制板 4 部分组成的整体。舵机不是一种单独的电机，它的内部是由直流电机驱动的。内部的控制电路板是一个电机的控制系统，整个舵机内部形成了一个闭环的控制系统。

        PWM 信号输入到控制板，给控制板一个指定的目标角度，然后这个电位器检测输出轴的当前角度，如果大于目标角度，电机就会反转，如果小于目标角度，电机就会正转，最终使输出轴固定在指定的角度，这就是舵机的内部工作流程（简而言之：输入一个 PWM 波形，输出轴固定在一个角度）。

>   “伺服”—词源于希腊语 “奴隶” 的意思，英文为 Servo。人们想把某一个结构或系统当作一个得心应手的驯服工具，服从控制信号的要求而动作。伺服的主要任务是按照控制命令的要求，对输出信号和输出功率进行放大、变换与调控等处理，使驱动装置输出的力矩、速度和位置控制得非常灵活方便。由于它的 “伺服” 性能，因此而得名——伺服系统。它的优势在于：可以非常灵活地控制输出装置的力矩、速度和位置等物理参量。  
>   交流伺服电机和直流伺服电机的共同点是：利用传感器（编码器）对转子的位置、转速、力矩、转向进行检测，斌且将得到的信号经由伺服驱动器反馈给[伺服控制器](https://so.csdn.net/so/search?q=%E4%BC%BA%E6%9C%8D%E6%8E%A7%E5%88%B6%E5%99%A8&spm=1001.2101.3001.7020)，从而达到调节转子位置、转速、力矩、转向的目的； 二者的不同点在于，一般而言，交流伺服电机相较于直流伺服电机对转子有更高的控制精度。

![](https://i-blog.csdnimg.cn/blog_migrate/a61cc0b8c3e7c055f3c28f661efb3def.png)

       输入信号脉冲宽度，周期是 20ms，也就是一个上升沿到下一个上升沿之间的时间是 20ms。

  舵机对输入的 PWM 信号的要求如下：周期为 20ms（对应 50Hz），高电平宽度为 0.5 ~ 2.5ms（就是占空比是这个范围，对应的输出角度如上图）。这时一个 180° 的舵机，输出轴的角度是 - 90° 到 + 90° 或者你规定是 0° 到 180°，输入信号脉冲宽度与舵机输出轴转角的对应关系都是线性一一对应的，给个 PWM，输出轴就会固定在一个角度。实际应用中，比如机器人、机械臂可以用舵机来控制关节，遥控车、遥控船可以用舵机来控制方向。这里的 PWM 波形实际上是作为一个通信协议来使用的，与用 PWM 波形等效出一个模拟输出的关系不大，将 PWM 当成一个通信协议也是一个比较常见的应用，因为很多控制器都有 PWM 输出的功能，而且 PWM 只需要一根信号线就行了，这也是一种应用形式。

![](https://i-blog.csdnimg.cn/blog_migrate/2947ff90e69c9abe91c68a37095176a4.png)

![](https://i-blog.csdnimg.cn/blog_migrate/5d370a4be632e74e33b5fe86375f4d62.png)

        接下来，看一下舵机的硬件电路，上图第一个是引脚定义图，在舵机上有三根线，分别是黑（电源负极 GND）、红（电源正极 + 5V）、黄（PWM 信号线）。上图第二个图中，在实际应用中，GND 就接 GND，电源 + 5V 是电机的驱动电源（一般电机都是大功率设备，驱动电源也必须是大功率的输出设备，对于套件中，可以直接从 STLINK 的 5v 输出脚引一根线使用 USB 的 5V 供电），信号线 PWM 就直接接到 STM32 引脚上就行了，PWM 只是一个通信线，是不需要大功率的。

####   
 直流电机及驱动

![](https://i-blog.csdnimg.cn/blog_migrate/9f7efadeaf368dd0f270829cd0548638.png)

  可以用 PWM 来控制电机的速度。直流电机是一个单独的电机，里面是没有驱动电路的，所以我们就要外挂一个驱动电路来控制。直流电机是一种能将电能转换为机械能的装置，有两个电极。有两个电极，当电极正接时，电机正转，当电极反接时，电机反转。上图所示的电机是 130 直流电机。直流电机属于大功率器件，GPIO 口无法直接驱动，需要配合电机驱动电路来操作。本课程使用 TB6612 电机驱动芯片来驱动电机。

![](https://i-blog.csdnimg.cn/blog_migrate/34dfec0aeb671cfa712f0b82319de3e6.png)![](https://i-blog.csdnimg.cn/blog_migrate/a70fa0e2ac3264954160c49bc704e39d.png)  
  TB6612 是一款双路 H 桥型的直流电机驱动芯片，其中有两个驱动电路，可以独立地驱动两个直流电机并且控制其转速和方向。如上左图，是电机驱动板，芯片是 TB6612，外围电路只需三个滤波电容就行了。如上右图是 H 桥电路的基本结构，是由两路推挽电路组成的，比如左边上管导通，下管断开，那左边输出就是接在 VM 的电机电源正极；下管导通，上管断开，那就是接在 PGND 的电源负极；如果有两路推挽电路，中间接一个电机，左上和右下导通，电流就是从左流向右，右上和左下导通，电流的方向就反过来从右边流向左边，H 桥可以控制电流流过的方向，所以它能控制电机的正反转。

>         电机驱动电路同样也是一个研究课题，市面上也有很多的电机驱动可供选择，常见的电机驱动芯片有 TB6612、DRV8833、L9110、L298N 等，另外还有用分立元件 MOS 管搭建的驱动电路，它可以实现更大的驱动功率。当然也可以自己用 MOS 管设计电路。

  TB6612 电机驱动模块的连接电路图和引脚定义图如下所示：

![](https://i-blog.csdnimg.cn/blog_migrate/0a5d608825ae3be58ef727aecb1e37c1.png)

        如上图

*   VM 就是电机电源的正极，和舵机的电源要求是一样的，要接一个可以输出大电流的电源，电压和电机的额定电压保持一致，比如时 5v 的电机就接 5v 电压
*   VCC 是逻辑电平输入端，一般和控制器的电源保持一致。比如使用 STM32，是 3.3v 的器件，就接 3.3v
*   AO1\AO2\BO1\BO2 是两路电机的输出，可以分别接两个电机。AO1 和 AO2 就是 A 路的两个输出，它的控制端是上面的三个 PWMA、AIN1 和 AIN2，这三个引脚控制下面的 A 路电机，对应关系如上图的灰色填充，其中 PWMA 引脚要接 PWM 信号输出断 PA0，AIN1 和 AIN2 引脚可以任意接两个普通的 GPIO 口，这三个引脚给一个低功率的控制信号，驱动电路就会从 VM 汲取电流来输出到电机，这样就能完成低功率的控制信号控制大功率设备的目的。右边的 BO1 及 BO2 这一路也是和 A 路的功能和操作方法是完全一样的。
*   STBY 引脚意为 Stand By，为待机控制引脚。如果接 GND，芯片就不工作，处于待机状态。如果接到逻辑高电平 VCC（3.3V）芯片就正常工作。如果不需要待机模式的话可以直接接 VCC3.3v，如果需要控制可以接入任意一个 GPIO 口，给高低电平就可以进行控制。

![](https://i-blog.csdnimg.cn/blog_migrate/614e21d1e955c13ed923d92d72ef95a8.png)

        PWMA、AIN1 和 AIN2 三个引脚控制电机正反转和速度：如上图下面的表，

*   STBY 低电平就待机，高电平就正常工作。
*   如果 IN1 和 IN2 全接高电平，两个输出 O1 和 O2 都为低电平，这样两个输出就没有电压差，电机是不会转的（制动），全高或全低，电机都不会转
*   如果 IN1 和 IN2 全接低电平，两个输出 O1 和 O2 直接关闭，电机也是不会转的
*   如果 IN1 给低电平、IN2 接高电平，如果 PWM 给高电平，那输出就是一低一高，有输出电压差，电机可以转，这时候定义的是反转；如果 PWM 给低电平，那输出两个低电平，电机还是不转（制动），这就是反转的逻辑（IN1 给低 IN2 给高，PWM 高反转低不转）。如果 PWM 是一个不断翻转的电平信号，那电机就是快速的反转、停止、反转、停止，如果 PWM 频率足够快，电机就可以连续稳定的反转，并且速度取决于 PWM 信号的占空比，这就是反转的工作流程。在这里的 PWM 就是使用 PWM 来等效一个模拟量的功能。
*   正转和上面差不多。IN1 给高 IN2 给低，PWM 高正转低不转。如果 PWM 频率足够快，电机就是连续稳定地正转了，并且速度取决于 PWM 信号的占空比。

### 参考手册

![](https://i-blog.csdnimg.cn/blog_migrate/a8b3725b2d678d2b50aa04aeaeb1491b.png)

![](https://i-blog.csdnimg.cn/blog_migrate/7faf21d2a56b3b4fd62bb7f54dc99f7f.png)

![](https://i-blog.csdnimg.cn/blog_migrate/438d60f51e30bbd1658839a57ece1fef.png)

![](https://i-blog.csdnimg.cn/blog_migrate/2cbe5b217190ef05af63a7ba5794ad79.png)

![](https://i-blog.csdnimg.cn/blog_migrate/376ee22a1b2f8ce4e4c0f6e06947c026.png)